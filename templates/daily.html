{% extends "base.html" %}

{% block title %}Daily Lineup Optimizer{% endblock %}

{% block extra_css %}
<link href="/static/css/main.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
{% endblock %}

{% block content %}
<div class="optimizer-container">
  <h1 class="text-center mb-4">Daily Sorare MLB Lineup Optimizer</h1>

  <div class="alert alert-info text-center">
    This tool excludes sealed cards and any card already used in this game week.
  </div>

  <div class="weather-report-container">
    <div class="card">
      <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
        <h4 class="mb-0"><i class="bi bi-cloud-rain"></i> Today's Weather Report</h4>
        <button type="button" class="btn btn-sm btn-light" id="refreshWeatherBtn">
          <i class="bi bi-arrow-clockwise"></i> Refresh
        </button>
      </div>
      <div class="card-body">
        <div id="weatherReport">
          <div class="text-center">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading weather...</span>
            </div>
            <p class="mt-2">Loading today's weather report...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <form id="dailyLineupForm" method="POST">
    <div class="row mb-3">
      <div class="col-md-6">
        <label for="username" class="form-label">Sorare Username</label>
        <input type="text" class="form-control" id="username" name="username" required>
      </div>
      <div class="col-md-6">
        <label for="ignore_players" class="form-label">Ignore Players (comma-separated)</label>
        <input type="text" class="form-control" id="ignore_players" name="ignore_players">
      </div>
    </div>
    
    <div class="row mb-3">
      <div class="col-md-12">
        <label for="ignore_games" class="form-label">
          <i class="bi bi-ban"></i> Ignore Games
          <span class="badge bg-info" data-bs-toggle="tooltip" title="Games with rain risk are easily added from the Weather Report section above">
            <i class="bi bi-info-circle"></i>
          </span>
        </label>
        <div class="input-group">
          <input type="text" class="form-control" id="ignore_games" name="ignore_games" placeholder="e.g. 12345, 67890">
          <button class="btn btn-outline-secondary" type="button" id="clearIgnoreGamesBtn" title="Clear all ignored games">
            <i class="bi bi-x-circle"></i> Clear
          </button>
        </div>
        <small class="form-text text-muted">Games listed here will be excluded from lineup generation. Add games with weather concerns from the report above.</small>
      </div>
    </div>
    <div class="row mb-3">
      <div class="col-md-4">
          <label for="rare_energy" class="form-label">Rare Energy</label>
          <input type="number" class="form-control" id="rare_energy" name="rare_energy" value="0">
      </div>
      <div class="col-md-3">
          <label for="limited_energy" class="form-label">Limited Energy</label>
          <input type="number" class="form-control" id="limited_energy" name="limited_energy" value="0">
      </div>
    </div>
    <div class="row mb-3">
      <div class="col-md-4">
        <label for="boost_2025" class="form-label">2025 Card Boost</label>
        <input type="number" step="0.1" class="form-control" id="boost_2025" name="boost_2025" value="0.0">
      </div>
      <div class="col-md-4">
        <label for="stack_boost" class="form-label">Stack Boost</label>
        <input type="number" step="0.1" class="form-control" id="stack_boost" name="stack_boost" value="2.0">
      </div>
    </div>

    <div class="mb-3">
      <button type="submit" class="btn btn-primary w-100" id="generateLineupBtn">Generate Daily Lineups</button>
    </div>
    <div class="d-grid gap-2 mt-2">
      <button type="button" id="updateDailyBtn" class="btn btn-secondary w-100">
        Update Daily Projections
      </button>
    </div>
  </form>

  <div id="resultsSection" class="mt-4" style="display: none;">
    <h3>Results for <span id="results-username"></span></h3>
    <div class="lineup-content" id="lineupResults"></div>
  </div>

  <div class="mt-4">
    <button class="btn btn-info w-100" type="button" data-bs-toggle="collapse" data-bs-target="#excludedLineupsCollapse" aria-expanded="false" aria-controls="excludedLineupsCollapse" id="toggleExcludedLineupsBtn">
      <i class="bi bi-zoom-in"></i> View Excluded Lineups (Cards Used in Other Game Weeks)
    </button>
    <div class="collapse mt-3" id="excludedLineupsCollapse">
      <div id="excludedLineupsContent">
        <div class="text-center">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading excluded lineups...</span>
          </div>
          <p class="mt-2">Loading excluded lineups...</p>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Load saved username from localStorage if available
  const lastUsername = localStorage.getItem('sorare-last-username');
  const usernameInput = document.getElementById('username');
  
  if (lastUsername && usernameInput) {
    usernameInput.value = lastUsername;
  }
  
  // Save username to localStorage when it changes
  usernameInput.addEventListener('input', function() {
    const username = this.value.trim();
    if (username) {
      localStorage.setItem('sorare-last-username', username);
    }
  });

  // Load today's weather report
  loadTodayWeatherReport();

  // Initialize ignore games functionality
  initializeIgnoreGamesClearButton();
  updateWeatherReportButtons();

  // Set up event delegation for the ignore game buttons that will be added dynamically
  document.getElementById('weatherReport').addEventListener('click', function(e) {
    if (e.target && e.target.classList.contains('ignore-game-btn')) {
      const gameId = e.target.getAttribute('data-game-id');
      addGameToIgnoreList(gameId);
      
      // Update button state
      e.target.classList.remove('btn-warning');
      e.target.classList.add('btn-secondary');
      e.target.textContent = 'Added to Ignore List';
      e.target.disabled = true;
      
      // Highlight the row to indicate it's been added
      const row = e.target.closest('tr');
      row.classList.add('table-secondary');
    }
  });

  // Set up the refresh weather button event listener
  const refreshWeatherBtn = document.getElementById('refreshWeatherBtn');
  if (refreshWeatherBtn) {
    refreshWeatherBtn.addEventListener('click', function() {
      this.disabled = true;
      this.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Refreshing...';
      
      loadTodayWeatherReport().then(() => {
        this.disabled = false;
        this.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Refresh';
      });
    });
  }

  // Initialize tooltips
  var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  var tooltipList = tooltipTriggerList.map(function(tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
  });

  // --- New JavaScript for Excluded Lineups ---
  const excludedLineupsCollapseElement = document.getElementById('excludedLineupsCollapse');
  const excludedLineupsContent = document.getElementById('excludedLineupsContent');
  const toggleExcludedLineupsBtn = document.getElementById('toggleExcludedLineupsBtn');
  let hasLoadedExcludedLineups = false; // Flag to load only once

  excludedLineupsCollapseElement.addEventListener('show.bs.collapse', function () {
    if (!hasLoadedExcludedLineups) {
      const username = document.getElementById('username').value;
      if (!username) {
        excludedLineupsContent.innerHTML = '<div class="alert alert-warning">Please enter your Sorare Username to view excluded lineups.</div>';
        // Prevent collapse from fully opening if no username
        // This might require more advanced Bootstrap JS control, or just let it open with the warning.
        // For simplicity, we'll let it open with the warning.
        return;
      }

      // Show loading spinner
      excludedLineupsContent.innerHTML = `
        <div class="text-center">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading excluded lineups...</span>
          </div>
          <p class="mt-2">Loading excluded lineups...</p>
        </div>
      `;

      // Fetch excluded lineups
      fetch(`/fetch_excluded_lineups?username=${encodeURIComponent(username)}`)
        .then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          return response.text();
        })
        .then(html => {
          excludedLineupsContent.innerHTML = html;
          hasLoadedExcludedLineups = true; // Set flag so it doesn't reload on subsequent expands
        })
        .catch(error => {
          console.error('Error fetching excluded lineups:', error);
          excludedLineupsContent.innerHTML = `<div class="alert alert-danger">Error loading excluded lineups: ${error.message}. Please try again later.</div>`;
        });
    }
  });

  // Reset hasLoadedExcludedLineups flag if username changes
  usernameInput.addEventListener('input', function() {
    hasLoadedExcludedLineups = false;
  });

});

// Array of funny baseball-themed loading messages for lineup generation
const lineupLoadingMessages = [
  "üèà Calling up the best players from Triple-A...",
  "‚öæ Checking who's got their rally caps on...",
  "üß¢ Consulting the magic 8-ball (it's in the dugout)...",
  "üìä Crunching numbers harder than peanut shells...",
  "üèüÔ∏è Building your lineup from the ground up...",
  "‚öæ Teaching your players advanced sabermetrics...",
  "ü•ú Buying Cracker Jacks for good luck...",
  "üéØ Aiming for the green monster of profits...",
  "üèÉ‚Äç‚ôÇÔ∏è Stealing second base... and third... and home...",
  "‚öæ Warming up the bullpen algorithms...",
  "üî• Looking for players hotter than a July doubleheader...",
  "üìà Calculating exit velocity and launch angles...",
  "üèÜ Searching for tomorrow's MVP candidates...",
  "‚öæ Checking if anyone's on a hot streak...",
  "üé™ Juggling stats like a circus performer..."
];

// Array of funny baseball-themed loading messages for projection updates
const projectionLoadingMessages = [
  "üìä Updating the crystal ball with fresh stats...",
  "üîÆ Consulting the baseball gods for divine projections...",
  "‚öæ Polishing the statistical magnifying glass...",
  "üìà Downloading the latest baseball matrix code...",
  "ü§ñ Teaching robots how to hit curveballs...",
  "üìä Recalibrating the projection cannon...",
  "‚öæ Feeding fresh data to the number-crunching hamsters...",
  "üîß Tightening the bolts on the prediction machine...",
  "üì° Receiving signals from the baseball satellite...",
  "üßÆ Converting coffee into statistical projections...",
  "‚öæ Updating the algorithm's batting average...",
  "üéØ Fine-tuning the projection dartboard...",
  "‚öæ Syncing with the official scorer's notebook...",
  "üîÑ Refreshing the crystal ball's browser cache..."
];

function getRandomMessage(messagesArray) {
  return messagesArray[Math.floor(Math.random() * messagesArray.length)];
}

function setButtonLoading(button, loadingText, originalText) {
  console.log('Setting loading state:', loadingText); // Debug log
  button.disabled = true;
  button.innerHTML = `<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>${loadingText}`;
  button.dataset.originalText = originalText;
}

function resetButtonLoading(button) {
  console.log('Resetting button to:', button.dataset.originalText); // Debug log
  button.disabled = false;
  button.innerHTML = button.dataset.originalText || button.textContent;
}

document.getElementById("dailyLineupForm").addEventListener("submit", function(e) {
  e.preventDefault();
  const username = document.getElementById("username").value;
  const form = e.target;
  const formData = new FormData(form);
  const generateBtn = document.getElementById("generateLineupBtn");
  const randomMessage = getRandomMessage(lineupLoadingMessages);
  
  // Set loading state with random message
  setButtonLoading(generateBtn, randomMessage, "Generate Daily Lineups");
  
  document.getElementById("results-username").textContent = username;
  fetch("/daily-lineup", {
    method: "POST",
    body: formData
  })
  .then(res => res.text())
  .then(html => {
    document.getElementById("lineupResults").innerHTML = html;
    document.getElementById("resultsSection").style.display = "block";
    resetButtonLoading(generateBtn);
  })
  .catch(err => {
    alert("Error generating lineups: " + err);
    resetButtonLoading(generateBtn);
  });
});

document.getElementById("updateDailyBtn").addEventListener("click", function () {
  const updateBtn = this;
  const randomMessage = getRandomMessage(projectionLoadingMessages);
  
  // Set loading state with random message
  setButtonLoading(updateBtn, randomMessage, "Update Daily Projections");
  
  fetch("/update_daily", { method: "POST" })
    .then(res => res.json())
    .then(data => {
      alert(data.message || "Daily projections updated.");
      resetButtonLoading(updateBtn);
    })
    .catch(err => {
      alert("Error updating projections: " + err);
      resetButtonLoading(updateBtn);
    });
});

/**
 * Load today's weather report from the server (filtered for current day only)
 * @returns {Promise} A promise that resolves when the weather report is loaded
 */
function loadTodayWeatherReport() {
  return fetch('/weather_report?daily=true')
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        document.getElementById('weatherReport').innerHTML = data.weather_html;
        
        // After loading weather report, check which games are already in ignore list
        updateWeatherReportButtons();
      } else {
        document.getElementById('weatherReport').innerHTML = '<div class="alert alert-danger">Failed to load weather report</div>';
      }
      return data;
    })
    .catch(error => {
      document.getElementById('weatherReport').innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
      throw error;
    });
}

/**
 * Add a game ID to the ignore games input field
 */
function addGameToIgnoreList(gameId) {
  const ignoreGamesInput = document.getElementById('ignore_games');
  let currentIds = ignoreGamesInput.value.split(',').map(id => id.trim()).filter(id => id);
  
  // Only add the ID if it's not already in the list
  if (!currentIds.includes(gameId)) {
    currentIds.push(gameId);
    ignoreGamesInput.value = currentIds.join(', ');
    
    // Show feedback to the user
    const alertHtml = `
      <div class="alert alert-success alert-dismissible fade show mt-2" role="alert">
        Game ID ${gameId} added to ignore list
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    `;
    
    const alertContainer = document.createElement('div');
    alertContainer.innerHTML = alertHtml;
    document.querySelector('.weather-report-container').appendChild(alertContainer.firstElementChild);
    
    // Auto dismiss after 3 seconds
    setTimeout(() => {
      const alert = document.querySelector('.weather-report-container .alert');
      if (alert) {
        alert.remove();
      }
    }, 3000);
  }
}

/**
 * Update the ignore game buttons based on what's already in the ignore list
 */
function updateWeatherReportButtons() {
  const ignoreGamesInput = document.getElementById('ignore_games');
  const currentIds = ignoreGamesInput.value.split(',').map(id => id.trim()).filter(id => id);
  
  // Find all the ignore game buttons in the weather report
  const ignoreButtons = document.querySelectorAll('.ignore-game-btn');
  
  ignoreButtons.forEach(button => {
    const gameId = button.getAttribute('data-game-id');
    
    if (currentIds.includes(gameId)) {
      // This game is already being ignored, update the button
      button.classList.remove('btn-warning');
      button.classList.add('btn-secondary');
      button.textContent = 'Added to Ignore List';
      button.disabled = true;
      
      // Also update the row
      const row = button.closest('tr');
      if (row) {
        row.classList.add('table-secondary');
      }
    }
  });
}

/**
 * Add a clear button to the ignore games list
 */
function initializeIgnoreGamesClearButton() {
  const ignoreGamesInput = document.getElementById('ignore_games');
  if (!ignoreGamesInput) return;
  
  // Find the clear button
  let clearButton = document.getElementById('clearIgnoreGamesBtn');
  
  if (clearButton) {
    // Add the event listener
    clearButton.addEventListener('click', function() {
      ignoreGamesInput.value = '';
      
      // Update the weather report buttons
      updateWeatherReportButtons();
      
      // Show feedback
      const alertHtml = `
        <div class="alert alert-info alert-dismissible fade show mt-2" role="alert">
          Ignore games list cleared
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label=\"Close\"></button>
        </div>
      `;
      
      const alertContainer = document.createElement('div');
      alertContainer.innerHTML = alertHtml;
      document.querySelector('.weather-report-container').appendChild(alertContainer.firstElementChild);
      
      // Auto dismiss after 3 seconds
      setTimeout(() => {
        const alert = document.querySelector('.weather-report-container .alert');
        if (alert) {
          alert.remove();
        }
      }, 3000);
    });
  }
}
</script>
{% endblock %}