<!-- templates/index.html - Main page template -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sorare MLB Lineup Optimizer</title>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/plugins/MultiDrag/MultiDrag.min.js"></script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding-top: 20px;
            padding-bottom: 40px;
            background-color: #f8f9fa;
        }
        /* Dark mode for generated content */
        body.dark-mode .lineup-content {
            background-color: #1e1e1e;
            color: #e0e0e0;
            }

            body.dark-mode .lineup-content table {
            background-color: #2a2a2a;
            color: #e0e0e0;
            border-color: #444;
            }

            body.dark-mode .lineup-content th,
            body.dark-mode .lineup-content td {
            border: 1px solid #444;
            }

            body.dark-mode .lineup-content h2,
            body.dark-mode .lineup-content h3,
            body.dark-mode .lineup-content h4 {
            color: #f0f0f0;
            }

            body.dark-mode .lineup-content a {
            color: #66bfff;
            }
        .optimizer-container {
            max-width: 960px;
            margin: 0 auto;
        }
        .form-container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        .results-container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
            display: none;
        }
        .lineup-content {
            font-family: system-ui, sans-serif;
            font-size: 0.95rem;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            max-height: 600px;
            overflow-y: auto;
        }
        .loading {
            text-align: center;
            padding: 20px;
            display: none;
        }
        .db-status {
            font-size: 0.8rem;
            margin-bottom: 15px;
        }
        .db-init-container {
            background-color: #fff3cd;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
            display: none;
        }
        .lineup-order-container {
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
            max-height: 300px;
            overflow-y: auto;
        }
        .card-tier {
            margin-bottom: 5px;
            font-weight: 500;
        }
        .rare-tier {
            color: #0d6efd;
        }
        .limited-tier {
            color: #198754;
        }
        .common-tier {
            color: #6c757d;
        }
        #activeLineup, #inactiveLineup {
            min-height: 200px;
            border: 1px dashed #ccc;
            padding: 10px;
            border-radius: 5px;
        }
        body.dark-mode {
        background-color: #121212;
        color: #e0e0e0;
        }

        .dark-mode .form-container,
        .dark-mode .results-container,
        .dark-mode .db-init-container,
        .dark-mode .list-group-item {
        background-color: #1e1e1e;
        color: #e0e0e0;
        border-color: #333;
        }

        .dark-mode .list-group-item.bg-info {
        background-color: #0d6efd !important;
        color: #fff;
        }

        .dark-mode .btn {
        border-color: #555;
        }

        .dark-mode .btn-outline-danger {
        color: #ff6b6b;
        border-color: #ff6b6b;
        }

        .dark-mode .btn-outline-danger:hover {
        background-color: #ff6b6b;
        color: white;
        }

    </style>
</head>
<body>
    <div class="optimizer-container">
        <div class="d-flex justify-content-end align-items-center mb-3">
            <label class="form-check-label me-2" for="darkModeToggle">Dark Mode</label>
            <input class="form-check-input" type="checkbox" id="darkModeToggle">
        </div>
        <h1 class="text-center mb-4">Sorare MLB Lineup Optimizer</h1>
       
        <div class="db-status alert alert-secondary">
            <strong>Status:</strong> Checking database connection...
        </div>
        
        <!-- New database initialization container -->
        <div class="db-init-container" id="dbInitContainer">
            <h4>Database Initialization Required</h4>
            <p>The database does not exist or is missing required tables. You need to initialize the database before you can generate lineups.</p>
            <p><strong>This will:</strong></p>
            <ul>
                <li>Download data from Fangraphs</li>
                <li>Download park factor data</li>
                <li>Process statistical projections</li>
                <li>Update stadium information</li>
            </ul>
            <p><strong>Note:</strong> This process may take several minutes.</p>
            <div class="d-grid gap-2">
                <button type="button" id="fullUpdateBtn" class="btn btn-warning">Initialize Database</button>
            </div>
        </div>
        
        <div class="form-container">
            <form id="lineupForm">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="username" class="form-label">Sorare Username</label>
                        <input type="text" class="form-control" id="username" name="username" required>
                    </div>
                    <div class="col-md-6">
                        <label for="ignore_players" class="form-label">Ignore Players (comma-separated)</label>
                        <input type="text" class="form-control" id="ignore_players" name="ignore_players">
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-3">
                        <label for="rare_energy" class="form-label">Rare Energy</label>
                        <input type="number" class="form-control" id="rare_energy" name="rare_energy" value="{{ default_rare_energy }}">
                    </div>
                    <div class="col-md-3">
                        <label for="limited_energy" class="form-label">Limited Energy</label>
                        <input type="number" class="form-control" id="limited_energy" name="limited_energy" value="{{ default_limited_energy }}">
                    </div>
                    <div class="col-md-3">
                        <label for="boost_2025" class="form-label">2025 Card Boost</label>
                        <input type="number" step="0.1" class="form-control" id="boost_2025" name="boost_2025" value="{{ default_boost_2025 }}">
                    </div>
                    <div class="col-md-3">
                        <label for="stack_boost" class="form-label">Stack Boost</label>
                        <input type="number" step="0.1" class="form-control" id="stack_boost" name="stack_boost" value="{{ default_stack_boost }}">
                    </div>
                </div>
              
                <div class="mb-3">
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">Lineup Order</label>
                            <ul id="activeLineup" class="list-group min-vh-50" style="min-height: 200px;">
                              <li class="list-group-item">Common Minors</li>
                            </ul>
                          </div>
                          <div class="col-md-6">
                            <label class="form-label">Inactive</label>
                            <ul id="inactiveLineup" class="list-group bg-light" style="min-height: 200px;">
                              <li class="list-group-item">Rare Champion_1</li>
                              <li class="list-group-item">Rare Champion_2</li>
                              <li class="list-group-item">Rare Champion_3</li>
                              <li class="list-group-item">Rare All-Star_1</li>
                              <li class="list-group-item">Rare All-Star_2</li>
                              <li class="list-group-item">Rare All-Star_3</li>
                              <li class="list-group-item">Rare Challenger_1</li>
                              <li class="list-group-item">Rare Challenger_2</li>
                              <li class="list-group-item">Limited All-Star_1</li>
                              <li class="list-group-item">Limited All-Star_2</li>
                              <li class="list-group-item">Limited All-Star_3</li>
                              <li class="list-group-item">Limited Champion_1</li>
                              <li class="list-group-item">Limited Champion_2</li>
                              <li class="list-group-item">Limited Champion_3</li>
                              <li class="list-group-item">Limited Challenger_1</li>
                              <li class="list-group-item">Limited Challenger_2</li>
                            </ul>
                          </div>
                      </div>
                      
                      <!-- Hidden input that gets updated -->
                      <input type="hidden" id="lineup_order" name="lineup_order" value="">
                      
                </div>
                
                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-primary" id="generateBtn">Generate Lineups</button>
                    <div class="row mt-2">
                        <div class="col-md-6">
                            <button type="button" id="updateDataBtn" class="btn btn-secondary w-100">Update Injuries & Projections</button>
                        </div>
                        <div class="col-md-6">
                            <button type="button" id="fullRefreshBtn" class="btn btn-outline-danger w-100">Full Database Refresh</button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        
        <div class="loading">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2" id="loadingMessage">Processing your request... This may take a minute.</p>
        </div>
        
        <div class="results-container">
            <h3>Lineups for <span id="results-username"></span></h3>
            <p>Game Week: {{ game_week }}</p>
                       
            <div class="lineup-content" id="lineupResults"></div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Dark mode functionality
            const toggle = document.getElementById('darkModeToggle');
            const body = document.body;

            // Apply stored dark mode
            if (localStorage.getItem('darkMode') === 'true') {
                body.classList.add('dark-mode');
                toggle.checked = true;
            }

            toggle.addEventListener('change', function () {
                if (toggle.checked) {
                    body.classList.add('dark-mode');
                    localStorage.setItem('darkMode', 'true');
                } else {
                    body.classList.remove('dark-mode');
                    localStorage.setItem('darkMode', 'false');
                }
            });

            // Get references to DOM elements for lineup management
            const active = document.getElementById('activeLineup');
            const inactive = document.getElementById('inactiveLineup');
            const lineupInput = document.getElementById('lineup_order');
            const usernameInput = document.getElementById('username');
            const form = document.getElementById('lineupForm');

            // Track manual changes to prevent automatic overwriting
            let hasManualChanges = false;

            // Save the last used username
            function saveLastUsername(username) {
                if (username && username.trim()) {
                    localStorage.setItem('sorare-last-username', username.trim());
                }
            }

            // Load the last used username
            function loadLastUsername() {
                const lastUsername = localStorage.getItem('sorare-last-username');
                if (lastUsername) {
                    usernameInput.value = lastUsername;
                    return lastUsername;
                }
                return null;
            }

            // Save lineup configuration
            function saveLineupConfiguration() {
                const username = usernameInput.value.trim();
                if (!username) return false; // Don't save if no username
                
                // Save username
                saveLastUsername(username);
                
                const activeItems = Array.from(active.querySelectorAll('li')).map(item => item.textContent.trim());
                const inactiveItems = Array.from(inactive.querySelectorAll('li')).map(item => item.textContent.trim());
                
                const config = {
                    active: activeItems,
                    inactive: inactiveItems,
                    timestamp: Date.now()
                };
                
                // Save with username as key
                localStorage.setItem(`sorare-lineup-${username}`, JSON.stringify(config));
                return true;
            }

            // Load lineup configuration
            function loadLineupConfiguration(username) {
                const savedConfig = localStorage.getItem(`sorare-lineup-${username}`);
                if (!savedConfig) return false;
                
                // If user has made manual changes, ask before overwriting
                if (hasManualChanges) {
                    const loadSaved = confirm("You have unsaved changes to your current lineup. Do you want to load your saved lineup for this username instead?");
                    if (!loadSaved) return false;
                }
                
                try {
                    const config = JSON.parse(savedConfig);
                    
                    // Clear current lineups - move everything to inactive first
                    while (active.children.length > 0) {
                        inactive.appendChild(active.children[0]);
                    }
                    
                    // Restore saved active lineup items
                    config.active.forEach(itemText => {
                        const matchingItem = Array.from(inactive.querySelectorAll('li')).find(
                            li => li.textContent.trim() === itemText
                        );
                        if (matchingItem) {
                            active.appendChild(matchingItem);
                        }
                    });
                    
                    // Update the hidden input
                    updateLineupOrder(false); // Don't mark as manual changes when loading
                    return true;
                } catch (e) {
                    console.error("Error loading saved lineup configuration:", e);
                    return false;
                }
            }

            // Update the lineup order and hidden input
            function updateLineupOrder(isManual = true) {
                const items = active.querySelectorAll('li');
                const lineup = Array.from(items).map(item => item.textContent.trim());
                lineupInput.value = lineup.join(', ');
                
                // Mark as having manual changes if this was a user action
                if (isManual) {
                    hasManualChanges = true;
                }
                
                // Auto-save if username is provided
                if (usernameInput.value.trim() && isManual) {
                    saveLineupConfiguration();
                    hasManualChanges = false;
                }
            }

            // Add a temporary message to notify the user
            function showMessage(message, type = 'info') {
                const existingMessage = document.querySelector('.temp-message');
                if (existingMessage) {
                    existingMessage.remove();
                }
                
                const messageDiv = document.createElement('div');
                messageDiv.className = `alert alert-${type} mt-2 temp-message`;
                messageDiv.textContent = message;
                
                const formContainer = document.querySelector('.form-container');
                formContainer.insertAdjacentElement('afterend', messageDiv);
                
                setTimeout(() => {
                    messageDiv.remove();
                }, 3000);
            }

            // Initialize Sortable.js
            const sortableOptions = {
                group: 'lineups',
                animation: 150,
                multiDrag: true,
                selectedClass: 'bg-info text-white',
                onSort: function() { updateLineupOrder(true); },
                onAdd: function() { updateLineupOrder(true); },
                onRemove: function() { updateLineupOrder(true); }
            };

            new Sortable(active, sortableOptions);
            new Sortable(inactive, sortableOptions);

            // Add "Save Current Lineup" button
            const formActions = document.querySelector('.d-grid.gap-2');
            
            if (!document.getElementById('saveLineupBtn')) {
                const saveButton = document.createElement('button');
                saveButton.id = 'saveLineupBtn';
                saveButton.type = 'button';
                saveButton.className = 'btn btn-outline-success mt-2';
                saveButton.textContent = 'Save Current Lineup';
                saveButton.addEventListener('click', function() {
                    const username = usernameInput.value.trim();
                    if (!username) {
                        showMessage('Please enter a username to save your lineup', 'warning');
                        usernameInput.focus();
                        return;
                    }
                    
                    if (saveLineupConfiguration()) {
                        hasManualChanges = false;
                        showMessage(`Lineup saved for ${username}`, 'success');
                    }
                });
                formActions.appendChild(saveButton);
            }

            // Add "Clear Saved Data" button
            if (!document.getElementById('clearDataBtn')) {
                const clearButton = document.createElement('button');
                clearButton.id = 'clearDataBtn';
                clearButton.type = 'button';
                clearButton.className = 'btn btn-outline-secondary mt-2';
                clearButton.textContent = 'Clear Saved Data';
                clearButton.addEventListener('click', function() {
                    if (confirm('This will clear your saved username and lineup configuration. Continue?')) {
                        const username = usernameInput.value.trim();
                        if (username) {
                            localStorage.removeItem(`sorare-lineup-${username}`);
                        }
                        localStorage.removeItem('sorare-last-username');
                        usernameInput.value = '';
                        showMessage('All saved data has been cleared', 'info');
                        
                        // Reset lineups to default
                        while (active.children.length > 0) {
                            inactive.appendChild(active.children[0]);
                        }
                        updateLineupOrder(false);
                        hasManualChanges = false;
                    }
                });
                formActions.appendChild(clearButton);
            }

            // Handle username change
            let usernameChangeTimer;
            usernameInput.addEventListener('input', function() {
                clearTimeout(usernameChangeTimer);
                usernameChangeTimer = setTimeout(() => {
                    const username = this.value.trim();
                    if (username) {
                        loadLineupConfiguration(username);
                    }
                }, 1000); // Wait 1 second after typing stops
            });

            // Handle form submission
            form.addEventListener('submit', function(e) {
                e.preventDefault();

                saveLineupConfiguration();
                
                // Show loading spinner
                document.querySelector('.loading').style.display = 'block';
                document.getElementById('loadingMessage').textContent = 'Generating lineups... This may take a minute.';
                document.querySelector('.results-container').style.display = 'none';
                
                // Get form data
                const formData = new FormData(form);
                
                // Add fixed energy per card value (always 25)
                formData.append('energy_per_card', 25);
                
                // Send request
                fetch('/generate_lineup', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    document.querySelector('.loading').style.display = 'none';

                    if (data.error) {
                        alert(data.error);
                        return;
                    }

                    document.getElementById('results-username').textContent = formData.get('username');
                    document.getElementById('lineupResults').innerHTML = data.lineup_html;
                    document.querySelector('.results-container').style.display = 'block';
                })
                .catch(error => {
                    document.querySelector('.loading').style.display = 'none';
                    alert(`Error: ${error.message}`);
                });
            });

            // Add warning when leaving with unsaved changes
            window.addEventListener('beforeunload', function(e) {
                if (hasManualChanges && !usernameInput.value.trim()) {
                    const message = 'You have unsaved lineup changes. Enter a username and save to keep them.';
                    e.returnValue = message;
                    return message;
                }
            });

            // Initial setup - load last username if available
            const lastUsername = loadLastUsername();
            if (lastUsername) {
                setTimeout(() => {
                    loadLineupConfiguration(lastUsername);
                }, 100);
            }

            // Make sure lineup input is updated on page load
            updateLineupOrder(false);

            // Check database status
            function checkDatabaseStatus() {
                fetch('/check_db')
                    .then(response => response.json())
                    .then(data => {
                        const statusDiv = document.querySelector('.db-status');
                        const generateBtn = document.getElementById('generateBtn');
                        const dbInitContainer = document.getElementById('dbInitContainer');
                        
                        if (data.status === 'connected') {
                            statusDiv.className = 'db-status alert alert-success';
                            statusDiv.innerHTML = `
                                <strong>Database Connected:</strong> 
                                Game Week: ${data.game_week} | 
                                Tables: ${data.tables.join(', ')} | 
                                Projections: ${data.projection_count}
                            `;
                            generateBtn.disabled = false;
                            dbInitContainer.style.display = 'none';
                        } else if (data.status === 'missing') {
                            statusDiv.className = 'db-status alert alert-warning';
                            statusDiv.innerHTML = `
                                <strong>Database Not Ready:</strong> 
                                ${data.message}
                            `;
                            generateBtn.disabled = true;
                            dbInitContainer.style.display = 'block';
                        } else {
                            statusDiv.className = 'db-status alert alert-danger';
                            statusDiv.textContent = `Database Error: ${data.message}`;
                            generateBtn.disabled = true;
                        }
                    })
                    .catch(error => {
                        const statusDiv = document.querySelector('.db-status');
                        statusDiv.className = 'db-status alert alert-danger';
                        statusDiv.textContent = `Error checking database: ${error}`;
                        document.getElementById('generateBtn').disabled = true;
                    });
            }

            // Full database refresh button
            document.getElementById('fullRefreshBtn').addEventListener('click', function() {
                if (!confirm('WARNING: This will completely refresh the database from scratch, downloading all data and recreating projections. This process will take several minutes. Continue?')) {
                    return;
                }
                runFullUpdate();
            });

            // Initialize database button
            document.getElementById('fullUpdateBtn').addEventListener('click', function() {
                runFullUpdate();
            });

            function runFullUpdate() {
                document.querySelector('.loading').style.display = 'block';
                document.getElementById('loadingMessage').textContent = 'Initializing database... This will take several minutes.';
                
                fetch('/run_full_update', {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    document.querySelector('.loading').style.display = 'none';
                    
                    if (data.error) {
                        alert(data.error);
                    } else {
                        alert(data.message);
                        window.location.reload();
                    }
                })
                .catch(error => {
                    document.querySelector('.loading').style.display = 'none';
                    alert(`Error: ${error.message}`);
                });
            }

            checkDatabaseStatus();
        });
    </script>
</body>
</html>